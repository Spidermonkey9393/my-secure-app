name: "Security CodeQL Scan"

on:
  pull_request:
    branches: ["dev", "stage", "main"]
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  #########################################
  # 1. Detect Go
  #########################################
  detect-go:
    runs-on: ubuntu-latest
    outputs:
      has_go: ${{ steps.detect.outputs.has_go }}

    steps:
      - uses: actions/checkout@v4

      - id: detect
        run: |
          if git ls-files '*.go' | grep -q .; then
            echo "has_go=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_go=false" >> "$GITHUB_OUTPUT"
          fi

  #########################################
  # 2. CodeQL Scan
  #########################################
  codeql-backend:
    needs: detect-go
    if: ${{ needs.detect-go.outputs.has_go == 'true' && github.actor != 'dependabot[bot]' }}
    runs-on: ubuntu-latest

    permissions:
      security-events: write
      contents: read
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "stable"

      - uses: github/codeql-action/init@v4
        with:
          languages: go
          queries: security-extended

      #########################################
      # SAFE BUILD (module OR GOPATH)
      #########################################
      - name: Build Go code (required for CodeQL)
        shell: bash
        run: |
          set -e

          if [ -f go.mod ]; then
            echo "Using Go modules"
            go build ./...
          else
            echo "Using GOPATH mode"
            export GO111MODULE=off
            mkdir -p "$GOPATH/src/app"
            rsync -a . "$GOPATH/src/app/"
            cd "$GOPATH/src/app"
            go build ./...
          fi

      - uses: github/codeql-action/analyze@v4
        with:
          category: "/language:go"
          output: codeql-results
