name: "Security CodeQL Scan"

on:
  pull_request:
    branches: ["dev", "stage", "main"]
  push:
    branches: ["main"]

permissions:
  contents: read

jobs:
  #########################################
  # 1. Detect whether repo contains Go code
  #########################################
  detect-go:
    name: Detect Go
    runs-on: ubuntu-latest
    outputs:
      has_go: ${{ steps.detect.outputs.has_go }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - id: detect
        shell: bash
        run: |
          set -euo pipefail

          # Detect Go source (ignore vendor, generated dirs)
          if git ls-files \
            '*.go' 'go.mod' 'go.sum' \
            ':!**/vendor/**' ':!**/dist/**' ':!**/build/**' \
            | grep -q .; then
            echo "has_go=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_go=false" >> "$GITHUB_OUTPUT"
          fi

  #########################################
  # 2. CodeQL Scan (runs only if Go exists)
  #########################################
  codeql-backend:
    name: Security CodeQL Scan
    needs: detect-go
    if: ${{ needs.detect-go.outputs.has_go == 'true' && github.actor != 'dependabot[bot]' }}
    runs-on: ubuntu-latest

    permissions:
      security-events: write
      contents: read
      actions: read
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL (Go)
        uses: github/codeql-action/init@v4
        with:
          languages: go
          queries: security-extended

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "stable"
          cache: true

      - name: Build Go project
        run: |
          set -euo pipefail
          go mod download
          go build ./...

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:go"
          output: codeql-results

      #########################################
      # 3. Severity Evaluation (High / Medium)
      #########################################
      - name: Evaluate High/Critical and Medium findings
        id: sev-check
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update && sudo apt-get install -y jq

          HIGH_COUNT=0
          MEDIUM_COUNT=0
          shopt -s nullglob

          for sarif in codeql-results/*.sarif; do
            HIGH=$(
              jq -r '
                [ .runs[]?.results[]?
                  | select(
                      (
                        ((.properties["security-severity"] // "") | tostring | length) > 0
                        and ((.properties["security-severity"] | tonumber) >= 7.0)
                      )
                      or (.level == "error")
                    )
                ] | length
              ' "$sarif" 2>/dev/null || echo 0
            )

            MEDIUM=$(
              jq -r '
                [ .runs[]?.results[]?
                  | select(
                      (
                        ((.properties["security-severity"] // "") | tostring | length) > 0
                        and ((.properties["security-severity"] | tonumber) >= 4.0)
                        and ((.properties["security-severity"] | tonumber) < 7.0)
                      )
                      or (.level == "warning")
                    )
                ] | length
              ' "$sarif" 2>/dev/null || echo 0
            )

            HIGH_COUNT=$((HIGH_COUNT + HIGH))
            MEDIUM_COUNT=$((MEDIUM_COUNT + MEDIUM))
          done

          echo "HIGH_COUNT=$HIGH_COUNT"
          echo "MEDIUM_COUNT=$MEDIUM_COUNT"

          echo "high_count=$HIGH_COUNT" >> "$GITHUB_OUTPUT"
          echo "medium_count=$MEDIUM_COUNT" >> "$GITHUB_OUTPUT"

          if [ "$HIGH_COUNT" -gt 0 ] || [ "$MEDIUM_COUNT" -gt 0 ]; then
            echo "BLOCK=true" >> "$GITHUB_OUTPUT"
          else
            echo "BLOCK=false" >> "$GITHUB_OUTPUT"
          fi

      #########################################
      # 4. PR Comment
      #########################################
      - name: Comment on PR (High/Critical or Medium)
        if: ${{ github.event_name == 'pull_request' && steps.sev-check.outputs.BLOCK == 'true' }}
        uses: actions/github-script@v8
        env:
          HIGH: ${{ steps.sev-check.outputs.high_count }}
          MEDIUM: ${{ steps.sev-check.outputs.medium_count }}
        with:
          script: |
            const high = Number(process.env.HIGH || "0");
            const medium = Number(process.env.MEDIUM || "0");

            const body = [
              "## üîê Backend CodeQL Security Scan Results (Go)",
              "",
              `**High/Critical:** ${high}`,
              `**Medium:** ${medium}`,
              "",
              "üö´ **Merge blocked** due to High/Critical or Medium security findings.",
              "",
              "Review details in **Security ‚Üí Code scanning**."
            ].join("\n");

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body
            });

      #########################################
      # 5. Block PR
      #########################################
      - name: Block PR if High/Critical or Medium findings exist
        if: ${{ github.event_name == 'pull_request' && steps.sev-check.outputs.BLOCK == 'true' }}
        run: |
          echo "‚ùå High/Critical or Medium CodeQL findings detected. Blocking PR."
          exit 1
